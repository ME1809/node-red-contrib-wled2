<script type="text/javascript">
  RED.nodes.registerType("wled2", {
    category: "function",
    color: "#a6bbcf",
    defaults: {
      address: { value: "", required: true },
      brightness: { value: 128 },
      enableBrightness: { value: true },
      delay: { value: 0, validate: RED.validators.number() },
      enableDelay: { value: true },
      color1: { value: "#FFFFFF" },
      enableColor1: { value: true },
      color2: { value: "#FFFFFF" },
      enableColor2: { value: true },
      color3: { value: "#FFFFFF" },
      enableColor3: { value: true },
      effect: { value: 0 },
      enableEffect: { value: true },
      effectIntensity: { value: 128 },
      enableEffectIntensity: { value: true },
      effectSpeed: { value: 128 },
      enableEffectSpeed: { value: true },
      name: { value: "" },
      palette: { value: "0" },
      enablePalette: { value: true },
      preset: { value: null },
      enablePreset: { value: true },
      state: { value: "on" },
      enableState: { value: true },
    },
    inputs: 1,
    outputs: 1,
    icon: "wled.png",
    label: function() {
      return this.name || "wled2";
    },
    labelStyle: function() {
      return this.name ? "node_label_italic" : "";
    },
    oneditprepare: function() {
      $("#node-input-address").change({ currentEffect: this.effect, currentPalette: this.palette }, loadDropdowns);

      // When a label is clicked, toggle it's enabled/disabled status, if possible
      $("label").click(event => {
        // Get the element this click event applies to
        const label = $(event.currentTarget);
        const stateCheckbox = label.find("input").first();
        // If there isn't a checkbox inside the label, skip
        if (stateCheckbox.length !== 0) {          
          const elementFromLabel = $("#" + label.attr("for"));
          // If there isn't a field attached to the label, skip
          if (elementFromLabel.length == 1) {
            // Get the element that was actually clicked for this event, not it's parent.
            const clickedElement = $(event.target);
            // Flip state, checked == true, which means the field is enabled, so disabled is false.
            const newState = !stateCheckbox.prop("checked");
            // Check if what we clicked was the checkbox
            if (clickedElement.attr("id") !== stateCheckbox.attr("id")) {
              // If we didn't click the checkbox, flip the state of the checkbox, and the disabled state of the input
              stateCheckbox.prop("checked", newState);
              // Double flipped because the value we got before was when we hadn't flipped the checkbox.
              clickedElement.prop("disabled", !newState);
            } else {
              // If we did click the checkbox, just update the disabled state of the input
              clickedElement.prop("disabled", newState);
            }
          }
        }
      });

      // On page load for each label, get the checkbox inside
      // If it has a checkbox, update the label's referenced field to be enabled/disabled based on the checkbox
      $("label").each(function(index) {
        const label = $(this);
        const stateCheckbox = label.find("input").first();
        if (stateCheckbox.length !== 0) {
          const newState = !stateCheckbox.prop("checked");
          const elementFromLabel = $(`#${label.attr("for")}`);
          if (elementFromLabel.length == 1) {
            // Update the element to match it's enabled/disabled state from the checkbox
            elementFromLabel.prop("disabled", newState);
          }
        }
      });

      $("#node-input-delay").typedInput({
        type: "num",
        types: ["num"],
      });

      $("#node-config-discover").click(function() {
        if ($("#node-input-address").prop("tagName") === "INPUT") {
          searchAndSelectWled();
        } else {
          manualWledIP();
        }
      });

      // Swaps the server input field to a text box with the current server value in it.
      function manualWledIP() {
        var current = $("#node-input-address").val();
        $("#node-input-address").replaceWith('<input type="text" id="node-input-address" style="width: 100%"/>');
        $("#node-input-address").val(current);
      }

      // Swaps the server input field to a dropdown and triggers auto-discovery.
      async function searchAndSelectWled() {
        var current = $("#node-input-address").val();
        $("#node-input-address").replaceWith('<select id="node-input-address" style="width: 100%"></select>');
        $("#node-input-address").append(
          '<option selected="selected" value="null">Searching for WLED devices...</option>',
        );

        try {
          const devices = await $.getJSON("wled2/discover");
          if (!devices || devices.length == 0) {
            RED.notify("No WLED devices found", "error");
          }

          $("#node-input-address").empty();

          devices.map(device => {
            $("#node-input-address").append(
              `<option value="${device.address}">${device.address} ${device.name ? `(${device.name})` : ""}</option>`,
            );
          });
          $("#node-input-address").val(current);
        } catch (e) {
          RED.notify(`Unable to discover devices: ${e.responseText}`);
        }
      }

      function populateDropdown(dropdownId, items) {
        const dropdown = $(dropdownId);

        // Clear out all the old options, if any, first
        $(`${dropdownId} option`).remove();

        items.map(item => {
          const newOption = $(`<option value="${item.id}">${item.name}</option>`);
          dropdown.append(newOption);
        });
      }

      async function getSortedEffects() {
        const server = $("#node-input-address").val();

        if (!server) return;

        // Request the list of effects from the WLED device via the backend.
        // This works around https/http issues when running this node in a
        // NodeRed instance installed on Home Assistant.
        let effects = await $.getJSON(`wled2/effects/${server}`);

        if (!effects || effects.length == 0) {
          RED.notify("No effects found.", "error");
        }

        // Drop the first item in the list, which is the default, before sorting. Then sort the list
        // and add the default back in at the top.
        const defaultEffect = effects.shift();
        effects = effects.sort((a, b) => {
          if (a.name == b.name) return 0;
          if (a.name < b.name) return -1;
          if (a.name > b.name) return 1;
        });
        effects.unshift(defaultEffect);

        return effects;
      }

      async function getSortedPalettes() {
        const server = $("#node-input-address").val();

        if (!server) return;

        // Request the list of palettes from the WLED device via the backend.
        // This works around https/http issues when running this node in a
        // NodeRed instance installed on Home Assistant.
        let palettes = await $.getJSON(`wled2/palettes/${server}`);

        if (!palettes || palettes.length == 0) {
          RED.notify("No palettes found.", "error");
        }

        // Drop the first item in the list, which is the default, before sorting. Then sort the list
        // and add the default back in at the top.
        const defaultPalette = palettes.shift();
        palettes = palettes.sort((a, b) => {
          if (a.name == b.name) return 0;
          if (a.name < b.name) return -1;
          if (a.name > b.name) return 1;
        });
        palettes.unshift(defaultPalette);

        return palettes;
      }

      async function loadDropdowns({ data: { currentEffect, currentPalette } }) {
        // Attempt to retrieve from the WLED device
        const server = $("#node-input-address").val();
        if (!server) return;

        // Populate the effects dropdown from the device directly
        try {
          const effects = await getSortedEffects();
          populateDropdown("#node-input-effect", effects);
          $(`#node-input-effect option[value=${currentEffect}]`).attr("selected", "selected");
        } catch (e) {
          RED.notify(`Unable to retrieve list of effects from WLED device. ${e}`, "error");
        }

        // Populate the palettes dropdown from the device directly
        try {
          const palettes = await getSortedPalettes();
          populateDropdown("#node-input-palette", palettes);
          $(`#node-input-palette option[value=${currentPalette}]`).attr("selected", "selected");
        } catch (e) {
          RED.notify(`Unable to retrieve list of palettes from WLED device. ${e}`, "error");
        }
      }
    },
  });
</script>

<script type="text/html" data-template-name="wled2">
      <div class="form-row">
          <label for="node-input-name"><i class="icon-tag"></i> Name</label>
          <input type="text" id="node-input-name" placeholder="Name">
      </div>
      <div class="form-row">
        <label for="node-input-address"><i class="icon-server"></i> WLED server</label>
        <div style="display: inline-block; position: relative; width: 70%; height: 20px;">
          <div style="position: absolute; left: 0px; right: 40px;">
            <input type="text" id="node-input-address" placeholder="127.0.0.1" style="width: 100%">
          </div>
          <a id="node-config-discover" class="editor-button" style="position: absolute; right: 0px; top: 0px;">
            <i class="fa fa-search"></i>
          </a>
        </div>
      </div>
      <div class="form-row">

        <label for="node-input-state">
          <input class="ignore-click" style="margin: 0; width: auto;" type="checkbox" title="Enable?" alt="Enable?" id="node-input-enableState" />
          <i class="icon-tag"></i> State
        </label>
        <select id="node-input-state">
          <option value="on">on</option>
          <option value="off">off</option>
          <option value="toggle">toggle</option>
        </select>
      </div>
      <div class="form-row">
        <label for="node-input-brightness">
          <input style="margin: 0; width: auto;" type="checkbox" title="Enable?" alt="Enable?" id="node-input-enableBrightness" />
          <i class="icon-tag"></i> Brightness
        </label>
        <input type="range" id="node-input-brightness" min="1" max="255">
      </div>
      <div class="form-row">
        <label for="node-input-color1">
          <input style="margin: 0; width: auto;" type="checkbox" title="Enable?" alt="Enable?" id="node-input-enableColor1" />
          <i class="icon-tag"></i> Color
        </label>
        <input type="color" id="node-input-color1">
      </div>
      <div class="form-row">
        <label for="node-input-color2">
          <input style="margin: 0; width: auto;" type="checkbox" title="Enable?" alt="Enable?" id="node-input-enableColor2" />
          <i class="icon-tag"></i> Color 2
        </label>
        <input type="color" id="node-input-color2">
      </div>
      <div class="form-row">
        <label for="node-input-color3">
          <input style="margin: 0; width: auto;" type="checkbox" title="Enable?" alt="Enable?" id="node-input-enableColor3" />
          <i class="icon-tag"></i> Color 3
        </label>
        <input type="color" id="node-input-color3">
      </div>
      <div class="form-row">
        <label for="node-input-effect">
          <input style="margin: 0; width: auto;" type="checkbox" title="Enable?" alt="Enable?" id="node-input-enableEffect" />
          <i class="icon-server"></i> Effect
        </label>
        <select id="node-input-effect"></select>
    </div>
    <div class="form-row">
      <label for="node-input-effectSpeed">
        <input style="margin: 0; width: auto;" type="checkbox" title="Enable?" alt="Enable?" id="node-input-enableEffectSpeed" />
        <i class="icon-tag"></i> Effect speed
      </label>
      <input type="range" id="node-input-effectSpeed" min="0" max="255">
    </div>
    <div class="form-row">
      <label for="node-input-effectIntensity">
        <input style="margin: 0; width: auto;" type="checkbox" title="Enable?" alt="Enable?" id="node-input-enableEffectIntensity" />
        <i class="icon-tag"></i> Effect intensity
      </label>
      <input type="range" id="node-input-effectIntensity" min="0" max="255">
    </div>

      <div class="form-row">
        <label for="node-input-palette">
          <input style="margin: 0; width: auto;" type="checkbox" title="Enable?" alt="Enable?" id="node-input-enablePalette" />
          <i class="icon-server"></i> Palette
        </label>
        <select id="node-input-palette"></select>
    </div>
    <div class="form-row">
      <label for="node-input-preset">
        <input style="margin: 0; width: auto;" type="checkbox" title="Enable?" alt="Enable?" id="node-input-enablePreset" />
        <i class="icon-tag"></i> Preset
      </label>
      <input type="number" step="1" min="1" max="65535" placeholder="0" id="node-input-preset" />
  </div>
  <div class="form-row">
      <label for="node-input-delay">
        <input style="margin: 0; width: auto;" type="checkbox" title="Enable?" alt="Enable?" id="node-input-enableDelay" />
        <i class="fa fa-clock-o"></i> Delay before changing to solid (in seconds)
      </label>
      <input type="text" id="node-input-delay" placeholder="0">
    </div>
</script>

<script type="text/html" data-help-name="wled2">
  <p>A node for controlling lights via WLED.</p>

  <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload
            <span class="property-type">json</span>
        </dt>
        <dd>The WLED settings to set on the WLED device. These override any values specified in the node's properties.</dd>
    </dl>

    <ol class="node-ports">
      <li>Standard output
          <dl class="message-properties">
              <dt>payload <span class="property-type">json</span></dt>
              <dd>The payload that was received as input.</dd>
          </dl>
      </li>
  </ol>
</script>

<script type="text/javascript"></script>
